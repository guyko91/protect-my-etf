<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.etf.risk.adapter.persistence.mapper.UserMapper">

    <insert id="insertUser" parameterType="UserVO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO users (telegram_chat_id, telegram_username, created_at, updated_at)
        VALUES (#{telegramChatId}, #{telegramUsername}, #{createdAt}, #{updatedAt})
    </insert>

    <update id="updateUser" parameterType="UserVO">
        UPDATE users
        SET telegram_username = #{telegramUsername},
            updated_at = #{updatedAt}
        WHERE id = #{id}
    </update>

    <select id="selectById" resultType="UserVO">
        SELECT id, telegram_chat_id, telegram_username, created_at, updated_at
        FROM users
        WHERE id = #{id}
    </select>

    <select id="selectByTelegramChatId" resultType="UserVO">
        SELECT id, telegram_chat_id, telegram_username, created_at, updated_at
        FROM users
        WHERE telegram_chat_id = #{telegramChatId}
    </select>

    <select id="selectUsersHoldingETF" resultType="UserVO">
        SELECT DISTINCT u.id, u.telegram_chat_id, u.telegram_username, u.created_at, u.updated_at
        FROM users u
                 INNER JOIN user_portfolios up ON u.id = up.user_id
        WHERE up.etf_symbol = #{etfSymbol}
    </select>

    <select id="existsByTelegramChatId" resultType="boolean">
        SELECT EXISTS(
                       SELECT 1
                       FROM users
                       WHERE telegram_chat_id = #{telegramChatId}
                   )
    </select>

</mapper>
