<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.etf.risk.adapter.persistence.mapper.RiskMetricsMapper">

    <insert id="insertRiskMetrics" parameterType="RiskMetricsVO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO risk_metrics_history (etf_symbol, recorded_date, nav, current_price, premium_discount, leverage_ratio, nasdaq_trend, created_at)
        VALUES (#{etfSymbol}, #{recordedDate}, #{nav}, #{currentPrice}, #{premiumDiscount}, #{leverageRatio}, #{nasdaqTrend}, #{createdAt})
        ON CONFLICT (etf_symbol, recorded_date) DO UPDATE
            SET nav = EXCLUDED.nav,
                current_price = EXCLUDED.current_price,
                premium_discount = EXCLUDED.premium_discount,
                leverage_ratio = EXCLUDED.leverage_ratio,
                nasdaq_trend = EXCLUDED.nasdaq_trend
    </insert>

    <select id="selectLatestBySymbol" resultType="RiskMetricsVO">
        SELECT id, etf_symbol, recorded_date, nav, current_price, premium_discount, leverage_ratio, nasdaq_trend, created_at
        FROM risk_metrics_history
        WHERE etf_symbol = #{etfSymbol}
        ORDER BY recorded_date DESC
            LIMIT 1
    </select>

</mapper>
